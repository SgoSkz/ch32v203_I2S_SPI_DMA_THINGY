/*
 * Program: I2S bitbanging with ch32v203 SPI bit shifter register
 * Purpose: Bitbang I2S for smooth audio :D
 * Misc:
 *      This I2S bitbang can simulate 16 bit x 2 channel x 70312.5 fs.
 *      The sampling rate is non-standard because the BaudRatePrescaler
 *      values only allow for 2^n values.
 *      F_CPU/(PSC*BPS*CH) = 144MHz/(64*16*2) = 70312.5
 * Issues:
 *  - Non-integer multipliers fail because the audio buffer isn't looped
 *  properly
 *  - TBD
 * License: IDKJUITIRL
 *  - IDK Just Use It This Isn't (a) Real License
 *
 * @author  Sean W Jasin
 */
#include "ch32fun.h"
#include <stdint.h>
#include <stdio.h>

#define BITS_PER_SAMPLE 16
#define SAMPLES 4096
#define RATE 144000000/(64*2*BITS_PER_SAMPLE)

// For DMA to SPI1
static uint16_t audio_buffer[SAMPLES];

// BIG BOI LUT
static const uint16_t sine_lut[SAMPLES] = { 0, 25, 50, 75, 100, 125, 150, 175, 201, 226, 251, 276, 301, 326, 351, 376, 402, 427, 452, 477, 502, 527, 552, 577, 603, 628, 653, 678, 703, 728, 753, 778, 803, 828, 854, 879, 904, 929, 954, 979, 1004, 1029, 1054, 1079, 1104, 1130, 1155, 1180, 1205, 1230, 1255, 1280, 1305, 1330, 1355, 1380, 1405, 1430, 1455, 1480, 1505, 1530, 1555, 1580, 1605, 1630, 1655, 1680, 1705, 1730, 1755, 1780, 1805, 1830, 1855, 1880, 1905, 1930, 1955, 1980, 2005, 2030, 2055, 2080, 2105, 2130, 2155, 2179, 2204, 2229, 2254, 2279, 2304, 2329, 2354, 2379, 2403, 2428, 2453, 2478, 2503, 2528, 2552, 2577, 2602, 2627, 2652, 2676, 2701, 2726, 2751, 2776, 2800, 2825, 2850, 2875, 2899, 2924, 2949, 2974, 2998, 3023, 3048, 3072, 3097, 3122, 3146, 3171, 3196, 3220, 3245, 3270, 3294, 3319, 3343, 3368, 3393, 3417, 3442, 3466, 3491, 3515, 3540, 3565, 3589, 3614, 3638, 3663, 3687, 3712, 3736, 3760, 3785, 3809, 3834, 3858, 3883, 3907, 3931, 3956, 3980, 4005, 4029, 4053, 4078, 4102, 4126, 4151, 4175, 4199, 4224, 4248, 4272, 4296, 4321, 4345, 4369, 4393, 4417, 4442, 4466, 4490, 4514, 4538, 4562, 4587, 4611, 4635, 4659, 4683, 4707, 4731, 4755, 4779, 4803, 4827, 4851, 4875, 4899, 4923, 4947, 4971, 4995, 5019, 5043, 5067, 5091, 5115, 5139, 5162, 5186, 5210, 5234, 5258, 5282, 5305, 5329, 5353, 5377, 5400, 5424, 5448, 5471, 5495, 5519, 5542, 5566, 5590, 5613, 5637, 5661, 5684, 5708, 5731, 5755, 5778, 5802, 5825, 5849, 5872, 5896, 5919, 5943, 5966, 5989, 6013, 6036, 6059, 6083, 6106, 6129, 6153, 6176, 6199, 6223, 6246, 6269, 6292, 6315, 6339, 6362, 6385, 6408, 6431, 6454, 6477, 6500, 6523, 6547, 6570, 6593, 6616, 6639, 6662, 6684, 6707, 6730, 6753, 6776, 6799, 6822, 6845, 6868, 6890, 6913, 6936, 6959, 6981, 7004, 7027, 7050, 7072, 7095, 7118, 7140, 7163, 7185, 7208, 7230, 7253, 7276, 7298, 7321, 7343, 7365, 7388, 7410, 7433, 7455, 7478, 7500, 7522, 7545, 7567, 7589, 7611, 7634, 7656, 7678, 7700, 7722, 7745, 7767, 7789, 7811, 7833, 7855, 7877, 7899, 7921, 7943, 7965, 7987, 8009, 8031, 8053, 8075, 8097, 8118, 8140, 8162, 8184, 8206, 8227, 8249, 8271, 8292, 8314, 8336, 8357, 8379, 8400, 8422, 8444, 8465, 8487, 8508, 8530, 8551, 8572, 8594, 8615, 8637, 8658, 8679, 8701, 8722, 8743, 8764, 8786, 8807, 8828, 8849, 8870, 8891, 8912, 8934, 8955, 8976, 8997, 9018, 9039, 9060, 9081, 9101, 9122, 9143, 9164, 9185, 9206, 9226, 9247, 9268, 9289, 9309, 9330, 9351, 9371, 9392, 9412, 9433, 9454, 9474, 9495, 9515, 9535, 9556, 9576, 9597, 9617, 9637, 9658, 9678, 9698, 9718, 9739, 9759, 9779, 9799, 9819, 9839, 9859, 9880, 9900, 9920, 9940, 9960, 9979, 9999, 10019, 10039, 10059, 10079, 10099, 10118, 10138, 10158, 10178, 10197, 10217, 10237, 10256, 10276, 10295, 10315, 10334, 10354, 10373, 10393, 10412, 10432, 10451, 10470, 10490, 10509, 10528, 10547, 10567, 10586, 10605, 10624, 10643, 10662, 10681, 10700, 10719, 10738, 10757, 10776, 10795, 10814, 10833, 10852, 10871, 10889, 10908, 10927, 10946, 10964, 10983, 11002, 11020, 11039, 11057, 11076, 11094, 11113, 11131, 11150, 11168, 11187, 11205, 11223, 11242, 11260, 11278, 11296, 11314, 11333, 11351, 11369, 11387, 11405, 11423, 11441, 11459, 11477, 11495, 11513, 11531, 11548, 11566, 11584, 11602, 11620, 11637, 11655, 11673, 11690, 11708, 11725, 11743, 11760, 11778, 11795, 11813, 11830, 11847, 11865, 11882, 11899, 11917, 11934, 11951, 11968, 11985, 12003, 12020, 12037, 12054, 12071, 12088, 12105, 12122, 12139, 12155, 12172, 12189, 12206, 12223, 12239, 12256, 12273, 12289, 12306, 12322, 12339, 12355, 12372, 12388, 12405, 12421, 12438, 12454, 12470, 12487, 12503, 12519, 12535, 12551, 12568, 12584, 12600, 12616, 12632, 12648, 12664, 12680, 12696, 12711, 12727, 12743, 12759, 12775, 12790, 12806, 12822, 12837, 12853, 12868, 12884, 12900, 12915, 12930, 12946, 12961, 12977, 12992, 13007, 13022, 13038, 13053, 13068, 13083, 13098, 13113, 13128, 13143, 13158, 13173, 13188, 13203, 13218, 13233, 13248, 13262, 13277, 13292, 13307, 13321, 13336, 13350, 13365, 13380, 13394, 13408, 13423, 13437, 13452, 13466, 13480, 13495, 13509, 13523, 13537, 13551, 13565, 13579, 13593, 13607, 13621, 13635, 13649, 13663, 13677, 13691, 13705, 13718, 13732, 13746, 13759, 13773, 13787, 13800, 13814, 13827, 13841, 13854, 13868, 13881, 13894, 13908, 13921, 13934, 13947, 13960, 13974, 13987, 14000, 14013, 14026, 14039, 14052, 14065, 14077, 14090, 14103, 14116, 14129, 14141, 14154, 14167, 14179, 14192, 14204, 14217, 14229, 14242, 14254, 14267, 14279, 14291, 14303, 14316, 14328, 14340, 14352, 14364, 14376, 14388, 14400, 14412, 14424, 14436, 14448, 14460, 14472, 14483, 14495, 14507, 14518, 14530, 14542, 14553, 14565, 14576, 14588, 14599, 14611, 14622, 14633, 14644, 14656, 14667, 14678, 14689, 14700, 14711, 14722, 14733, 14744, 14755, 14766, 14777, 14788, 14799, 14810, 14820, 14831, 14842, 14852, 14863, 14873, 14884, 14894, 14905, 14915, 14926, 14936, 14946, 14957, 14967, 14977, 14987, 14997, 15007, 15017, 15027, 15037, 15047, 15057, 15067, 15077, 15087, 15097, 15106, 15116, 15126, 15135, 15145, 15155, 15164, 15174, 15183, 15192, 15202, 15211, 15221, 15230, 15239, 15248, 15257, 15267, 15276, 15285, 15294, 15303, 15312, 15321, 15329, 15338, 15347, 15356, 15365, 15373, 15382, 15391, 15399, 15408, 15416, 15425, 15433, 15442, 15450, 15458, 15467, 15475, 15483, 15491, 15500, 15508, 15516, 15524, 15532, 15540, 15548, 15556, 15563, 15571, 15579, 15587, 15595, 15602, 15610, 15618, 15625, 15633, 15640, 15648, 15655, 15662, 15670, 15677, 15684, 15692, 15699, 15706, 15713, 15720, 15727, 15734, 15741, 15748, 15755, 15762, 15769, 15776, 15782, 15789, 15796, 15802, 15809, 15816, 15822, 15829, 15835, 15841, 15848, 15854, 15861, 15867, 15873, 15879, 15885, 15892, 15898, 15904, 15910, 15916, 15922, 15927, 15933, 15939, 15945, 15951, 15956, 15962, 15968, 15973, 15979, 15984, 15990, 15995, 16001, 16006, 16011, 16017, 16022, 16027, 16032, 16038, 16043, 16048, 16053, 16058, 16063, 16068, 16073, 16077, 16082, 16087, 16092, 16096, 16101, 16106, 16110, 16115, 16119, 16124, 16128, 16133, 16137, 16141, 16146, 16150, 16154, 16158, 16162, 16166, 16170, 16174, 16178, 16182, 16186, 16190, 16194, 16198, 16201, 16205, 16209, 16212, 16216, 16220, 16223, 16227, 16230, 16233, 16237, 16240, 16243, 16247, 16250, 16253, 16256, 16259, 16262, 16265, 16268, 16271, 16274, 16277, 16280, 16283, 16285, 16288, 16291, 16293, 16296, 16299, 16301, 16304, 16306, 16308, 16311, 16313, 16315, 16318, 16320, 16322, 16324, 16326, 16328, 16330, 16332, 16334, 16336, 16338, 16340, 16342, 16343, 16345, 16347, 16349, 16350, 16352, 16353, 16355, 16356, 16358, 16359, 16360, 16362, 16363, 16364, 16365, 16366, 16367, 16368, 16369, 16370, 16371, 16372, 16373, 16374, 16375, 16376, 16376, 16377, 16378, 16378, 16379, 16379, 16380, 16380, 16381, 16381, 16381, 16382, 16382, 16382, 16382, 16382, 16382, 16382, 16383, 16382, 16382, 16382, 16382, 16382, 16382, 16382, 16381, 16381, 16381, 16380, 16380, 16379, 16379, 16378, 16378, 16377, 16376, 16376, 16375, 16374, 16373, 16372, 16371, 16370, 16369, 16368, 16367, 16366, 16365, 16364, 16363, 16362, 16360, 16359, 16358, 16356, 16355, 16353, 16352, 16350, 16349, 16347, 16345, 16343, 16342, 16340, 16338, 16336, 16334, 16332, 16330, 16328, 16326, 16324, 16322, 16320, 16318, 16315, 16313, 16311, 16308, 16306, 16304, 16301, 16299, 16296, 16293, 16291, 16288, 16285, 16283, 16280, 16277, 16274, 16271, 16268, 16265, 16262, 16259, 16256, 16253, 16250, 16247, 16243, 16240, 16237, 16233, 16230, 16227, 16223, 16220, 16216, 16212, 16209, 16205, 16201, 16198, 16194, 16190, 16186, 16182, 16178, 16174, 16170, 16166, 16162, 16158, 16154, 16150, 16146, 16141, 16137, 16133, 16128, 16124, 16119, 16115, 16110, 16106, 16101, 16096, 16092, 16087, 16082, 16077, 16073, 16068, 16063, 16058, 16053, 16048, 16043, 16038, 16032, 16027, 16022, 16017, 16011, 16006, 16001, 15995, 15990, 15984, 15979, 15973, 15968, 15962, 15956, 15951, 15945, 15939, 15933, 15927, 15922, 15916, 15910, 15904, 15898, 15892, 15885, 15879, 15873, 15867, 15861, 15854, 15848, 15841, 15835, 15829, 15822, 15816, 15809, 15802, 15796, 15789, 15782, 15776, 15769, 15762, 15755, 15748, 15741, 15734, 15727, 15720, 15713, 15706, 15699, 15692, 15684, 15677, 15670, 15662, 15655, 15648, 15640, 15633, 15625, 15618, 15610, 15602, 15595, 15587, 15579, 15571, 15563, 15556, 15548, 15540, 15532, 15524, 15516, 15508, 15500, 15491, 15483, 15475, 15467, 15458, 15450, 15442, 15433, 15425, 15416, 15408, 15399, 15391, 15382, 15373, 15365, 15356, 15347, 15338, 15329, 15321, 15312, 15303, 15294, 15285, 15276, 15267, 15257, 15248, 15239, 15230, 15221, 15211, 15202, 15192, 15183, 15174, 15164, 15155, 15145, 15135, 15126, 15116, 15106, 15097, 15087, 15077, 15067, 15057, 15047, 15037, 15027, 15017, 15007, 14997, 14987, 14977, 14967, 14957, 14946, 14936, 14926, 14915, 14905, 14894, 14884, 14873, 14863, 14852, 14842, 14831, 14820, 14810, 14799, 14788, 14777, 14766, 14755, 14744, 14733, 14722, 14711, 14700, 14689, 14678, 14667, 14656, 14644, 14633, 14622, 14611, 14599, 14588, 14576, 14565, 14553, 14542, 14530, 14518, 14507, 14495, 14483, 14472, 14460, 14448, 14436, 14424, 14412, 14400, 14388, 14376, 14364, 14352, 14340, 14328, 14316, 14303, 14291, 14279, 14267, 14254, 14242, 14229, 14217, 14204, 14192, 14179, 14167, 14154, 14141, 14129, 14116, 14103, 14090, 14077, 14065, 14052, 14039, 14026, 14013, 14000, 13987, 13974, 13960, 13947, 13934, 13921, 13908, 13894, 13881, 13868, 13854, 13841, 13827, 13814, 13800, 13787, 13773, 13759, 13746, 13732, 13718, 13705, 13691, 13677, 13663, 13649, 13635, 13621, 13607, 13593, 13579, 13565, 13551, 13537, 13523, 13509, 13495, 13480, 13466, 13452, 13437, 13423, 13408, 13394, 13380, 13365, 13350, 13336, 13321, 13307, 13292, 13277, 13262, 13248, 13233, 13218, 13203, 13188, 13173, 13158, 13143, 13128, 13113, 13098, 13083, 13068, 13053, 13038, 13022, 13007, 12992, 12977, 12961, 12946, 12930, 12915, 12900, 12884, 12868, 12853, 12837, 12822, 12806, 12790, 12775, 12759, 12743, 12727, 12711, 12696, 12680, 12664, 12648, 12632, 12616, 12600, 12584, 12568, 12551, 12535, 12519, 12503, 12487, 12470, 12454, 12438, 12421, 12405, 12388, 12372, 12355, 12339, 12322, 12306, 12289, 12273, 12256, 12239, 12223, 12206, 12189, 12172, 12155, 12139, 12122, 12105, 12088, 12071, 12054, 12037, 12020, 12003, 11985, 11968, 11951, 11934, 11917, 11899, 11882, 11865, 11847, 11830, 11813, 11795, 11778, 11760, 11743, 11725, 11708, 11690, 11673, 11655, 11637, 11620, 11602, 11584, 11566, 11548, 11531, 11513, 11495, 11477, 11459, 11441, 11423, 11405, 11387, 11369, 11351, 11333, 11314, 11296, 11278, 11260, 11242, 11223, 11205, 11187, 11168, 11150, 11131, 11113, 11094, 11076, 11057, 11039, 11020, 11002, 10983, 10964, 10946, 10927, 10908, 10889, 10871, 10852, 10833, 10814, 10795, 10776, 10757, 10738, 10719, 10700, 10681, 10662, 10643, 10624, 10605, 10586, 10567, 10547, 10528, 10509, 10490, 10470, 10451, 10432, 10412, 10393, 10373, 10354, 10334, 10315, 10295, 10276, 10256, 10237, 10217, 10197, 10178, 10158, 10138, 10118, 10099, 10079, 10059, 10039, 10019, 9999, 9979, 9960, 9940, 9920, 9900, 9880, 9859, 9839, 9819, 9799, 9779, 9759, 9739, 9718, 9698, 9678, 9658, 9637, 9617, 9597, 9576, 9556, 9535, 9515, 9495, 9474, 9454, 9433, 9412, 9392, 9371, 9351, 9330, 9309, 9289, 9268, 9247, 9226, 9206, 9185, 9164, 9143, 9122, 9101, 9081, 9060, 9039, 9018, 8997, 8976, 8955, 8934, 8912, 8891, 8870, 8849, 8828, 8807, 8786, 8764, 8743, 8722, 8701, 8679, 8658, 8637, 8615, 8594, 8572, 8551, 8530, 8508, 8487, 8465, 8444, 8422, 8400, 8379, 8357, 8336, 8314, 8292, 8271, 8249, 8227, 8206, 8184, 8162, 8140, 8118, 8097, 8075, 8053, 8031, 8009, 7987, 7965, 7943, 7921, 7899, 7877, 7855, 7833, 7811, 7789, 7767, 7745, 7722, 7700, 7678, 7656, 7634, 7611, 7589, 7567, 7545, 7522, 7500, 7478, 7455, 7433, 7410, 7388, 7365, 7343, 7321, 7298, 7276, 7253, 7230, 7208, 7185, 7163, 7140, 7118, 7095, 7072, 7050, 7027, 7004, 6981, 6959, 6936, 6913, 6890, 6868, 6845, 6822, 6799, 6776, 6753, 6730, 6707, 6684, 6662, 6639, 6616, 6593, 6570, 6547, 6523, 6500, 6477, 6454, 6431, 6408, 6385, 6362, 6339, 6315, 6292, 6269, 6246, 6223, 6199, 6176, 6153, 6129, 6106, 6083, 6059, 6036, 6013, 5989, 5966, 5943, 5919, 5896, 5872, 5849, 5825, 5802, 5778, 5755, 5731, 5708, 5684, 5661, 5637, 5613, 5590, 5566, 5542, 5519, 5495, 5471, 5448, 5424, 5400, 5377, 5353, 5329, 5305, 5282, 5258, 5234, 5210, 5186, 5162, 5139, 5115, 5091, 5067, 5043, 5019, 4995, 4971, 4947, 4923, 4899, 4875, 4851, 4827, 4803, 4779, 4755, 4731, 4707, 4683, 4659, 4635, 4611, 4587, 4562, 4538, 4514, 4490, 4466, 4442, 4417, 4393, 4369, 4345, 4321, 4296, 4272, 4248, 4224, 4199, 4175, 4151, 4126, 4102, 4078, 4053, 4029, 4005, 3980, 3956, 3931, 3907, 3883, 3858, 3834, 3809, 3785, 3760, 3736, 3712, 3687, 3663, 3638, 3614, 3589, 3565, 3540, 3515, 3491, 3466, 3442, 3417, 3393, 3368, 3343, 3319, 3294, 3270, 3245, 3220, 3196, 3171, 3146, 3122, 3097, 3072, 3048, 3023, 2998, 2974, 2949, 2924, 2899, 2875, 2850, 2825, 2800, 2776, 2751, 2726, 2701, 2676, 2652, 2627, 2602, 2577, 2552, 2528, 2503, 2478, 2453, 2428, 2403, 2379, 2354, 2329, 2304, 2279, 2254, 2229, 2204, 2179, 2155, 2130, 2105, 2080, 2055, 2030, 2005, 1980, 1955, 1930, 1905, 1880, 1855, 1830, 1805, 1780, 1755, 1730, 1705, 1680, 1655, 1630, 1605, 1580, 1555, 1530, 1505, 1480, 1455, 1430, 1405, 1380, 1355, 1330, 1305, 1280, 1255, 1230, 1205, 1180, 1155, 1130, 1104, 1079, 1054, 1029, 1004, 979, 954, 929, 904, 879, 854, 828, 803, 778, 753, 728, 703, 678, 653, 628, 603, 577, 552, 527, 502, 477, 452, 427, 402, 376, 351, 326, 301, 276, 251, 226, 201, 175, 150, 125, 100, 75, 50, 25, 0, -25, -50, -75, -100, -125, -150, -175, -201, -226, -251, -276, -301, -326, -351, -376, -402, -427, -452, -477, -502, -527, -552, -577, -603, -628, -653, -678, -703, -728, -753, -778, -803, -828, -854, -879, -904, -929, -954, -979, -1004, -1029, -1054, -1079, -1104, -1130, -1155, -1180, -1205, -1230, -1255, -1280, -1305, -1330, -1355, -1380, -1405, -1430, -1455, -1480, -1505, -1530, -1555, -1580, -1605, -1630, -1655, -1680, -1705, -1730, -1755, -1780, -1805, -1830, -1855, -1880, -1905, -1930, -1955, -1980, -2005, -2030, -2055, -2080, -2105, -2130, -2155, -2179, -2204, -2229, -2254, -2279, -2304, -2329, -2354, -2379, -2403, -2428, -2453, -2478, -2503, -2528, -2552, -2577, -2602, -2627, -2652, -2676, -2701, -2726, -2751, -2776, -2800, -2825, -2850, -2875, -2899, -2924, -2949, -2974, -2998, -3023, -3048, -3072, -3097, -3122, -3146, -3171, -3196, -3220, -3245, -3270, -3294, -3319, -3343, -3368, -3393, -3417, -3442, -3466, -3491, -3515, -3540, -3565, -3589, -3614, -3638, -3663, -3687, -3712, -3736, -3760, -3785, -3809, -3834, -3858, -3883, -3907, -3931, -3956, -3980, -4005, -4029, -4053, -4078, -4102, -4126, -4151, -4175, -4199, -4224, -4248, -4272, -4296, -4321, -4345, -4369, -4393, -4417, -4442, -4466, -4490, -4514, -4538, -4562, -4587, -4611, -4635, -4659, -4683, -4707, -4731, -4755, -4779, -4803, -4827, -4851, -4875, -4899, -4923, -4947, -4971, -4995, -5019, -5043, -5067, -5091, -5115, -5139, -5162, -5186, -5210, -5234, -5258, -5282, -5305, -5329, -5353, -5377, -5400, -5424, -5448, -5471, -5495, -5519, -5542, -5566, -5590, -5613, -5637, -5661, -5684, -5708, -5731, -5755, -5778, -5802, -5825, -5849, -5872, -5896, -5919, -5943, -5966, -5989, -6013, -6036, -6059, -6083, -6106, -6129, -6153, -6176, -6199, -6223, -6246, -6269, -6292, -6315, -6339, -6362, -6385, -6408, -6431, -6454, -6477, -6500, -6523, -6547, -6570, -6593, -6616, -6639, -6662, -6684, -6707, -6730, -6753, -6776, -6799, -6822, -6845, -6868, -6890, -6913, -6936, -6959, -6981, -7004, -7027, -7050, -7072, -7095, -7118, -7140, -7163, -7185, -7208, -7230, -7253, -7276, -7298, -7321, -7343, -7365, -7388, -7410, -7433, -7455, -7478, -7500, -7522, -7545, -7567, -7589, -7611, -7634, -7656, -7678, -7700, -7722, -7745, -7767, -7789, -7811, -7833, -7855, -7877, -7899, -7921, -7943, -7965, -7987, -8009, -8031, -8053, -8075, -8097, -8118, -8140, -8162, -8184, -8206, -8227, -8249, -8271, -8292, -8314, -8336, -8357, -8379, -8400, -8422, -8444, -8465, -8487, -8508, -8530, -8551, -8572, -8594, -8615, -8637, -8658, -8679, -8701, -8722, -8743, -8764, -8786, -8807, -8828, -8849, -8870, -8891, -8912, -8934, -8955, -8976, -8997, -9018, -9039, -9060, -9081, -9101, -9122, -9143, -9164, -9185, -9206, -9226, -9247, -9268, -9289, -9309, -9330, -9351, -9371, -9392, -9412, -9433, -9454, -9474, -9495, -9515, -9535, -9556, -9576, -9597, -9617, -9637, -9658, -9678, -9698, -9718, -9739, -9759, -9779, -9799, -9819, -9839, -9859, -9880, -9900, -9920, -9940, -9960, -9979, -9999, -10019, -10039, -10059, -10079, -10099, -10118, -10138, -10158, -10178, -10197, -10217, -10237, -10256, -10276, -10295, -10315, -10334, -10354, -10373, -10393, -10412, -10432, -10451, -10470, -10490, -10509, -10528, -10547, -10567, -10586, -10605, -10624, -10643, -10662, -10681, -10700, -10719, -10738, -10757, -10776, -10795, -10814, -10833, -10852, -10871, -10889, -10908, -10927, -10946, -10964, -10983, -11002, -11020, -11039, -11057, -11076, -11094, -11113, -11131, -11150, -11168, -11187, -11205, -11223, -11242, -11260, -11278, -11296, -11314, -11333, -11351, -11369, -11387, -11405, -11423, -11441, -11459, -11477, -11495, -11513, -11531, -11548, -11566, -11584, -11602, -11620, -11637, -11655, -11673, -11690, -11708, -11725, -11743, -11760, -11778, -11795, -11813, -11830, -11847, -11865, -11882, -11899, -11917, -11934, -11951, -11968, -11985, -12003, -12020, -12037, -12054, -12071, -12088, -12105, -12122, -12139, -12155, -12172, -12189, -12206, -12223, -12239, -12256, -12273, -12289, -12306, -12322, -12339, -12355, -12372, -12388, -12405, -12421, -12438, -12454, -12470, -12487, -12503, -12519, -12535, -12551, -12568, -12584, -12600, -12616, -12632, -12648, -12664, -12680, -12696, -12711, -12727, -12743, -12759, -12775, -12790, -12806, -12822, -12837, -12853, -12868, -12884, -12900, -12915, -12930, -12946, -12961, -12977, -12992, -13007, -13022, -13038, -13053, -13068, -13083, -13098, -13113, -13128, -13143, -13158, -13173, -13188, -13203, -13218, -13233, -13248, -13262, -13277, -13292, -13307, -13321, -13336, -13350, -13365, -13380, -13394, -13408, -13423, -13437, -13452, -13466, -13480, -13495, -13509, -13523, -13537, -13551, -13565, -13579, -13593, -13607, -13621, -13635, -13649, -13663, -13677, -13691, -13705, -13718, -13732, -13746, -13759, -13773, -13787, -13800, -13814, -13827, -13841, -13854, -13868, -13881, -13894, -13908, -13921, -13934, -13947, -13960, -13974, -13987, -14000, -14013, -14026, -14039, -14052, -14065, -14077, -14090, -14103, -14116, -14129, -14141, -14154, -14167, -14179, -14192, -14204, -14217, -14229, -14242, -14254, -14267, -14279, -14291, -14303, -14316, -14328, -14340, -14352, -14364, -14376, -14388, -14400, -14412, -14424, -14436, -14448, -14460, -14472, -14483, -14495, -14507, -14518, -14530, -14542, -14553, -14565, -14576, -14588, -14599, -14611, -14622, -14633, -14644, -14656, -14667, -14678, -14689, -14700, -14711, -14722, -14733, -14744, -14755, -14766, -14777, -14788, -14799, -14810, -14820, -14831, -14842, -14852, -14863, -14873, -14884, -14894, -14905, -14915, -14926, -14936, -14946, -14957, -14967, -14977, -14987, -14997, -15007, -15017, -15027, -15037, -15047, -15057, -15067, -15077, -15087, -15097, -15106, -15116, -15126, -15135, -15145, -15155, -15164, -15174, -15183, -15192, -15202, -15211, -15221, -15230, -15239, -15248, -15257, -15267, -15276, -15285, -15294, -15303, -15312, -15321, -15329, -15338, -15347, -15356, -15365, -15373, -15382, -15391, -15399, -15408, -15416, -15425, -15433, -15442, -15450, -15458, -15467, -15475, -15483, -15491, -15500, -15508, -15516, -15524, -15532, -15540, -15548, -15556, -15563, -15571, -15579, -15587, -15595, -15602, -15610, -15618, -15625, -15633, -15640, -15648, -15655, -15662, -15670, -15677, -15684, -15692, -15699, -15706, -15713, -15720, -15727, -15734, -15741, -15748, -15755, -15762, -15769, -15776, -15782, -15789, -15796, -15802, -15809, -15816, -15822, -15829, -15835, -15841, -15848, -15854, -15861, -15867, -15873, -15879, -15885, -15892, -15898, -15904, -15910, -15916, -15922, -15927, -15933, -15939, -15945, -15951, -15956, -15962, -15968, -15973, -15979, -15984, -15990, -15995, -16001, -16006, -16011, -16017, -16022, -16027, -16032, -16038, -16043, -16048, -16053, -16058, -16063, -16068, -16073, -16077, -16082, -16087, -16092, -16096, -16101, -16106, -16110, -16115, -16119, -16124, -16128, -16133, -16137, -16141, -16146, -16150, -16154, -16158, -16162, -16166, -16170, -16174, -16178, -16182, -16186, -16190, -16194, -16198, -16201, -16205, -16209, -16212, -16216, -16220, -16223, -16227, -16230, -16233, -16237, -16240, -16243, -16247, -16250, -16253, -16256, -16259, -16262, -16265, -16268, -16271, -16274, -16277, -16280, -16283, -16285, -16288, -16291, -16293, -16296, -16299, -16301, -16304, -16306, -16308, -16311, -16313, -16315, -16318, -16320, -16322, -16324, -16326, -16328, -16330, -16332, -16334, -16336, -16338, -16340, -16342, -16343, -16345, -16347, -16349, -16350, -16352, -16353, -16355, -16356, -16358, -16359, -16360, -16362, -16363, -16364, -16365, -16366, -16367, -16368, -16369, -16370, -16371, -16372, -16373, -16374, -16375, -16376, -16376, -16377, -16378, -16378, -16379, -16379, -16380, -16380, -16381, -16381, -16381, -16382, -16382, -16382, -16382, -16382, -16382, -16382, -16383, -16382, -16382, -16382, -16382, -16382, -16382, -16382, -16381, -16381, -16381, -16380, -16380, -16379, -16379, -16378, -16378, -16377, -16376, -16376, -16375, -16374, -16373, -16372, -16371, -16370, -16369, -16368, -16367, -16366, -16365, -16364, -16363, -16362, -16360, -16359, -16358, -16356, -16355, -16353, -16352, -16350, -16349, -16347, -16345, -16343, -16342, -16340, -16338, -16336, -16334, -16332, -16330, -16328, -16326, -16324, -16322, -16320, -16318, -16315, -16313, -16311, -16308, -16306, -16304, -16301, -16299, -16296, -16293, -16291, -16288, -16285, -16283, -16280, -16277, -16274, -16271, -16268, -16265, -16262, -16259, -16256, -16253, -16250, -16247, -16243, -16240, -16237, -16233, -16230, -16227, -16223, -16220, -16216, -16212, -16209, -16205, -16201, -16198, -16194, -16190, -16186, -16182, -16178, -16174, -16170, -16166, -16162, -16158, -16154, -16150, -16146, -16141, -16137, -16133, -16128, -16124, -16119, -16115, -16110, -16106, -16101, -16096, -16092, -16087, -16082, -16077, -16073, -16068, -16063, -16058, -16053, -16048, -16043, -16038, -16032, -16027, -16022, -16017, -16011, -16006, -16001, -15995, -15990, -15984, -15979, -15973, -15968, -15962, -15956, -15951, -15945, -15939, -15933, -15927, -15922, -15916, -15910, -15904, -15898, -15892, -15885, -15879, -15873, -15867, -15861, -15854, -15848, -15841, -15835, -15829, -15822, -15816, -15809, -15802, -15796, -15789, -15782, -15776, -15769, -15762, -15755, -15748, -15741, -15734, -15727, -15720, -15713, -15706, -15699, -15692, -15684, -15677, -15670, -15662, -15655, -15648, -15640, -15633, -15625, -15618, -15610, -15602, -15595, -15587, -15579, -15571, -15563, -15556, -15548, -15540, -15532, -15524, -15516, -15508, -15500, -15491, -15483, -15475, -15467, -15458, -15450, -15442, -15433, -15425, -15416, -15408, -15399, -15391, -15382, -15373, -15365, -15356, -15347, -15338, -15329, -15321, -15312, -15303, -15294, -15285, -15276, -15267, -15257, -15248, -15239, -15230, -15221, -15211, -15202, -15192, -15183, -15174, -15164, -15155, -15145, -15135, -15126, -15116, -15106, -15097, -15087, -15077, -15067, -15057, -15047, -15037, -15027, -15017, -15007, -14997, -14987, -14977, -14967, -14957, -14946, -14936, -14926, -14915, -14905, -14894, -14884, -14873, -14863, -14852, -14842, -14831, -14820, -14810, -14799, -14788, -14777, -14766, -14755, -14744, -14733, -14722, -14711, -14700, -14689, -14678, -14667, -14656, -14644, -14633, -14622, -14611, -14599, -14588, -14576, -14565, -14553, -14542, -14530, -14518, -14507, -14495, -14483, -14472, -14460, -14448, -14436, -14424, -14412, -14400, -14388, -14376, -14364, -14352, -14340, -14328, -14316, -14303, -14291, -14279, -14267, -14254, -14242, -14229, -14217, -14204, -14192, -14179, -14167, -14154, -14141, -14129, -14116, -14103, -14090, -14077, -14065, -14052, -14039, -14026, -14013, -14000, -13987, -13974, -13960, -13947, -13934, -13921, -13908, -13894, -13881, -13868, -13854, -13841, -13827, -13814, -13800, -13787, -13773, -13759, -13746, -13732, -13718, -13705, -13691, -13677, -13663, -13649, -13635, -13621, -13607, -13593, -13579, -13565, -13551, -13537, -13523, -13509, -13495, -13480, -13466, -13452, -13437, -13423, -13408, -13394, -13380, -13365, -13350, -13336, -13321, -13307, -13292, -13277, -13262, -13248, -13233, -13218, -13203, -13188, -13173, -13158, -13143, -13128, -13113, -13098, -13083, -13068, -13053, -13038, -13022, -13007, -12992, -12977, -12961, -12946, -12930, -12915, -12900, -12884, -12868, -12853, -12837, -12822, -12806, -12790, -12775, -12759, -12743, -12727, -12711, -12696, -12680, -12664, -12648, -12632, -12616, -12600, -12584, -12568, -12551, -12535, -12519, -12503, -12487, -12470, -12454, -12438, -12421, -12405, -12388, -12372, -12355, -12339, -12322, -12306, -12289, -12273, -12256, -12239, -12223, -12206, -12189, -12172, -12155, -12139, -12122, -12105, -12088, -12071, -12054, -12037, -12020, -12003, -11985, -11968, -11951, -11934, -11917, -11899, -11882, -11865, -11847, -11830, -11813, -11795, -11778, -11760, -11743, -11725, -11708, -11690, -11673, -11655, -11637, -11620, -11602, -11584, -11566, -11548, -11531, -11513, -11495, -11477, -11459, -11441, -11423, -11405, -11387, -11369, -11351, -11333, -11314, -11296, -11278, -11260, -11242, -11223, -11205, -11187, -11168, -11150, -11131, -11113, -11094, -11076, -11057, -11039, -11020, -11002, -10983, -10964, -10946, -10927, -10908, -10889, -10871, -10852, -10833, -10814, -10795, -10776, -10757, -10738, -10719, -10700, -10681, -10662, -10643, -10624, -10605, -10586, -10567, -10547, -10528, -10509, -10490, -10470, -10451, -10432, -10412, -10393, -10373, -10354, -10334, -10315, -10295, -10276, -10256, -10237, -10217, -10197, -10178, -10158, -10138, -10118, -10099, -10079, -10059, -10039, -10019, -9999, -9979, -9960, -9940, -9920, -9900, -9880, -9859, -9839, -9819, -9799, -9779, -9759, -9739, -9718, -9698, -9678, -9658, -9637, -9617, -9597, -9576, -9556, -9535, -9515, -9495, -9474, -9454, -9433, -9412, -9392, -9371, -9351, -9330, -9309, -9289, -9268, -9247, -9226, -9206, -9185, -9164, -9143, -9122, -9101, -9081, -9060, -9039, -9018, -8997, -8976, -8955, -8934, -8912, -8891, -8870, -8849, -8828, -8807, -8786, -8764, -8743, -8722, -8701, -8679, -8658, -8637, -8615, -8594, -8572, -8551, -8530, -8508, -8487, -8465, -8444, -8422, -8400, -8379, -8357, -8336, -8314, -8292, -8271, -8249, -8227, -8206, -8184, -8162, -8140, -8118, -8097, -8075, -8053, -8031, -8009, -7987, -7965, -7943, -7921, -7899, -7877, -7855, -7833, -7811, -7789, -7767, -7745, -7722, -7700, -7678, -7656, -7634, -7611, -7589, -7567, -7545, -7522, -7500, -7478, -7455, -7433, -7410, -7388, -7365, -7343, -7321, -7298, -7276, -7253, -7230, -7208, -7185, -7163, -7140, -7118, -7095, -7072, -7050, -7027, -7004, -6981, -6959, -6936, -6913, -6890, -6868, -6845, -6822, -6799, -6776, -6753, -6730, -6707, -6684, -6662, -6639, -6616, -6593, -6570, -6547, -6523, -6500, -6477, -6454, -6431, -6408, -6385, -6362, -6339, -6315, -6292, -6269, -6246, -6223, -6199, -6176, -6153, -6129, -6106, -6083, -6059, -6036, -6013, -5989, -5966, -5943, -5919, -5896, -5872, -5849, -5825, -5802, -5778, -5755, -5731, -5708, -5684, -5661, -5637, -5613, -5590, -5566, -5542, -5519, -5495, -5471, -5448, -5424, -5400, -5377, -5353, -5329, -5305, -5282, -5258, -5234, -5210, -5186, -5162, -5139, -5115, -5091, -5067, -5043, -5019, -4995, -4971, -4947, -4923, -4899, -4875, -4851, -4827, -4803, -4779, -4755, -4731, -4707, -4683, -4659, -4635, -4611, -4587, -4562, -4538, -4514, -4490, -4466, -4442, -4417, -4393, -4369, -4345, -4321, -4296, -4272, -4248, -4224, -4199, -4175, -4151, -4126, -4102, -4078, -4053, -4029, -4005, -3980, -3956, -3931, -3907, -3883, -3858, -3834, -3809, -3785, -3760, -3736, -3712, -3687, -3663, -3638, -3614, -3589, -3565, -3540, -3515, -3491, -3466, -3442, -3417, -3393, -3368, -3343, -3319, -3294, -3270, -3245, -3220, -3196, -3171, -3146, -3122, -3097, -3072, -3048, -3023, -2998, -2974, -2949, -2924, -2899, -2875, -2850, -2825, -2800, -2776, -2751, -2726, -2701, -2676, -2652, -2627, -2602, -2577, -2552, -2528, -2503, -2478, -2453, -2428, -2403, -2379, -2354, -2329, -2304, -2279, -2254, -2229, -2204, -2179, -2155, -2130, -2105, -2080, -2055, -2030, -2005, -1980, -1955, -1930, -1905, -1880, -1855, -1830, -1805, -1780, -1755, -1730, -1705, -1680, -1655, -1630, -1605, -1580, -1555, -1530, -1505, -1480, -1455, -1430, -1405, -1380, -1355, -1330, -1305, -1280, -1255, -1230, -1205, -1180, -1155, -1130, -1104, -1079, -1054, -1029, -1004, -979, -954, -929, -904, -879, -854, -828, -803, -778, -753, -728, -703, -678, -653, -628, -603, -577, -552, -527, -502, -477, -452, -427, -402, -376, -351, -326, -301, -276, -251, -226, -201, -175, -150, -125, -100, -75, -50, -25 };

/*
 * Initializes necessary pins of ch32v203
 */
void GPIO_Init_All(void) {
    RCC->APB2PCENR |= RCC_APB2Periph_GPIOA;

    // SPI1: PA5=SCK, PA7=MOSI, rest unnecessary
	GPIOA->CFGLR = ( GPIO_Speed_50MHz | GPIO_CNF_OUT_PP_AF ) << ( 4 * 5 ) |
	               ( GPIO_Speed_50MHz | GPIO_CNF_OUT_PP_AF ) << ( 4 * 7 ) |
	               ( GPIO_Speed_50MHz | GPIO_CNF_OUT_PP_AF ) << ( 4 * 1 );

	// PA0 bound to TIM2_ETR
	GPIOA->CFGLR |= ( GPIO_CFGLR_IN_FLOAT ) << ( 4 * 0 );
}

/*
 * Initializes SPI and DMA
 * SPI Pins
 *  - MOSI PA7
 *  - MISO PA6
 *  - SCK PA5
 *  - NSS PA4
 */
void SPI1_DMA_Init(void) {
    RCC->APB2PCENR |= RCC_APB2Periph_SPI1;
    RCC->AHBPCENR  |= RCC_AHBPeriph_DMA1;

    // Turn of SPI before setting up
    SPI1->CTLR1 &= ~SPI_CTLR1_SPE;
	SPI1->CTLR1 = SPI_CTLR1_MSTR |
                  SPI_CTLR1_CPOL | 
                  SPI_CTLR1_CPHA |
                  SPI_DataSize_16b |
                  SPI_CTLR1_SSM |
                  SPI_CTLR1_SSI |
                  SPI_BaudRatePrescaler_64 | 
                  SPI_CTLR1_SPE;

    // Enable SPI DMA
    SPI1->CTLR2 = SPI_CTLR2_TXDMAEN;

    // DMA1 Channel3 (SPI1_TX)
	DMA1_Channel3->CFGR = DMA_CFGR3_MINC | 
                          DMA_CFGR3_DIR |
                          DMA_CFGR3_CIRC |
                          DMA_CFGR3_PSIZE_0 | 
                          DMA_CFGR3_MSIZE_0;
	DMA1_Channel3->PADDR = (uint32_t)&SPI1->DATAR;
    DMA1_Channel3->MADDR = (uint32_t)audio_buffer;
    DMA1_Channel3->CNTR  = SAMPLES;

    // Enable DMA
    DMA1_Channel3->CFGR |= DMA_CFGR3_EN;
}

/*
 * Set up TIM2 to trigger based on SPI SCK so we can have "synced" clocks. The
 * clocks aren't synced perfectly, but good enough to bitbang I2S. So it's
 * functionally good enough. Kind of ugly solution, must connect PA5 (SCK+BCLK)
 * to PA0 (TIM2_ETR). The output for WS/LRCK is PA1.
 */
void TIM2_Init_SPI_Trigger(void) {
	// Enable TIM2 clock
	RCC->APB1PCENR |= RCC_APB1Periph_TIM2;

	// Reset TIM2
	RCC->APB1PRSTR |= RCC_APB1Periph_TIM2;
	RCC->APB1PRSTR &= ~RCC_APB1Periph_TIM2;

	// Set auto-reload (ARR) for PWM frequency (divide by 32) 16 Left + 16 Right
	TIM2->ATRLR = (BITS_PER_SAMPLE<<1)-1;
	TIM2->CH2CVR = (TIM2->ATRLR+1) >> 1;

	// Configure CH2 as PWM1
	TIM2->CHCTLR1 &= ~0xFF00;
	TIM2->CHCTLR1 |= TIM_OC2M_1 | TIM_OC2M_2;
	TIM2->CCER |= TIM_CC2E;

	// External trigger source = ETRF
	TIM2->SMCFGR = TIM_TS_ETRF | TIM_MSM | TIM_ETP;

	// External clock mode
	TIM2->SMCFGR &= ~TIM_SMS;
	TIM2->SMCFGR |= TIM_SMS;

	// Start timer
	TIM2->CTLR1 |= TIM_CEN;
}

/*
 * Integer based rounding
 * Not fast, but good enough
 */
uint32_t iround(uint32_t num, uint32_t den) {
    return num % den < den>>1 ? num/den : num/den+1;
}

volatile uint16_t freq = 9500;
/*
 * Put the sounds into the buffer thing
 */
void update_dma_buffer(void) {

	// Get the decimal to be smaller by multiplying it by this value
	// the "factored" portion
	// See math here https://www.desmos.com/calculator/kenuknb777
	// Better solution: Find the number that minimizes the decimal instead of arbitrarily multiplying SAMPLES and then
	// rounding
	uint32_t factored = iround(freq*(SAMPLES-50), (RATE<<1));

    // Create factored_buffer size
    uint32_t factored_buf = iround((RATE<<1) * factored, freq);

    // Debug
    printf("%lu\n", factored);
    printf("%lu\n", factored_buf);

    DMA1_Channel3->CFGR &= ~DMA_CFGR3_EN;
    DMA1_Channel3->CNTR = factored_buf;
    DMA1_Channel3->CFGR |= DMA_CFGR3_EN;

    // Fill Buffer until factored_buffer size
    for(int i=0;i<factored_buf;i++) {
        // TODO: Fix issue misalignment part 2
        // NOTE: This shouldn't happen according to calculations. Will figure out later issue occuring at 9500Hz
        audio_buffer[i] = sine_lut[iround(i*factored*SAMPLES,factored_buf)&0xfff];
    }
}

int main(void) {
    SystemInit();
    GPIO_Init_All();
    // update_dma_buffer();
    SPI1_DMA_Init();
    TIM2_Init_SPI_Trigger();
    update_dma_buffer();

    while(1) {
        // update_dma_buffer();
        Delay_Ms(100);
        // freq+=10;
        // update_dma_buffer();
        printf("DMA1_Channel3->CNTR: %ld\n", DMA1_Channel3->CNTR);
    }
}
