/*
 * Program: I2S bitbanging with ch32v203 SPI bit shifter register
 * Purpose: Bitbang I2S for smooth audio :D
 * Misc:
 *      This I2S bitbang can simulate 16 bit x 2 channel x 70312.5 fs.
 *      The sampling rate is non-standard because the BaudRatePrescaler
 *      values only allow for 2^n values.
 *      F_CPU/(PSC*BPS*CH) = 144MHz/(64*16*2) = 70312.5
 * Issues:
 *  - Non-integer multipliers fail because the audio buffer isn't looped
 *  properly
 *  - TBD
 * License: IDKJUITIRL
 *  - IDK Just Use It This Isn't (a) Real License
 *
 * @author  Sean W Jasin
 */
#include "ch32fun.h"
#include <stdint.h>

#define BITS_PER_SAMPLE 16
#define SAMPLES 4096

// For DMA to SPI1
static int16_t audio_buffer[SAMPLES];

// BIG BOI LUT
static const int16_t cos_lut[SAMPLES] = { 0, 12, 25, 37, 50, 62, 75, 87, 100, 113, 125, 138, 150, 163, 175, 188, 200, 213, 226, 238, 251, 263, 276, 288, 301, 313, 326, 339, 351, 364, 376, 389, 401, 414, 426, 439, 451, 464, 477, 489, 502, 514, 527, 539, 552, 564, 577, 589, 602, 614, 627, 639, 652, 664, 677, 689, 702, 715, 727, 740, 752, 765, 777, 790, 802, 815, 827, 840, 852, 865, 877, 890, 902, 914, 927, 939, 952, 964, 977, 989, 1002, 1014, 1027, 1039, 1052, 1064, 1077, 1089, 1101, 1114, 1126, 1139, 1151, 1164, 1176, 1189, 1201, 1213, 1226, 1238, 1251, 1263, 1275, 1288, 1300, 1313, 1325, 1337, 1350, 1362, 1375, 1387, 1399, 1412, 1424, 1436, 1449, 1461, 1474, 1486, 1498, 1511, 1523, 1535, 1548, 1560, 1572, 1585, 1597, 1609, 1622, 1634, 1646, 1658, 1671, 1683, 1695, 1708, 1720, 1732, 1744, 1757, 1769, 1781, 1794, 1806, 1818, 1830, 1842, 1855, 1867, 1879, 1891, 1904, 1916, 1928, 1940, 1952, 1965, 1977, 1989, 2001, 2013, 2026, 2038, 2050, 2062, 2074, 2086, 2098, 2111, 2123, 2135, 2147, 2159, 2171, 2183, 2195, 2208, 2220, 2232, 2244, 2256, 2268, 2280, 2292, 2304, 2316, 2328, 2340, 2352, 2364, 2376, 2388, 2400, 2412, 2424, 2436, 2448, 2460, 2472, 2484, 2496, 2508, 2520, 2532, 2544, 2556, 2568, 2580, 2592, 2604, 2616, 2627, 2639, 2651, 2663, 2675, 2687, 2699, 2711, 2722, 2734, 2746, 2758, 2770, 2782, 2793, 2805, 2817, 2829, 2841, 2852, 2864, 2876, 2888, 2899, 2911, 2923, 2935, 2946, 2958, 2970, 2981, 2993, 3005, 3017, 3028, 3040, 3052, 3063, 3075, 3086, 3098, 3110, 3121, 3133, 3145, 3156, 3168, 3179, 3191, 3202, 3214, 3226, 3237, 3249, 3260, 3272, 3283, 3295, 3306, 3318, 3329, 3341, 3352, 3363, 3375, 3386, 3398, 3409, 3421, 3432, 3443, 3455, 3466, 3478, 3489, 3500, 3512, 3523, 3534, 3546, 3557, 3568, 3580, 3591, 3602, 3613, 3625, 3636, 3647, 3658, 3670, 3681, 3692, 3703, 3715, 3726, 3737, 3748, 3759, 3770, 3782, 3793, 3804, 3815, 3826, 3837, 3848, 3859, 3870, 3881, 3892, 3904, 3915, 3926, 3937, 3948, 3959, 3970, 3981, 3992, 4003, 4013, 4024, 4035, 4046, 4057, 4068, 4079, 4090, 4101, 4112, 4122, 4133, 4144, 4155, 4166, 4177, 4187, 4198, 4209, 4220, 4230, 4241, 4252, 4263, 4273, 4284, 4295, 4306, 4316, 4327, 4338, 4348, 4359, 4369, 4380, 4391, 4401, 4412, 4422, 4433, 4444, 4454, 4465, 4475, 4486, 4496, 4507, 4517, 4528, 4538, 4549, 4559, 4569, 4580, 4590, 4601, 4611, 4621, 4632, 4642, 4652, 4663, 4673, 4683, 4694, 4704, 4714, 4724, 4735, 4745, 4755, 4765, 4776, 4786, 4796, 4806, 4816, 4827, 4837, 4847, 4857, 4867, 4877, 4887, 4897, 4907, 4917, 4927, 4937, 4947, 4957, 4967, 4977, 4987, 4997, 5007, 5017, 5027, 5037, 5047, 5057, 5067, 5077, 5086, 5096, 5106, 5116, 5126, 5135, 5145, 5155, 5165, 5174, 5184, 5194, 5204, 5213, 5223, 5233, 5242, 5252, 5262, 5271, 5281, 5290, 5300, 5310, 5319, 5329, 5338, 5348, 5357, 5367, 5376, 5386, 5395, 5405, 5414, 5423, 5433, 5442, 5452, 5461, 5470, 5480, 5489, 5498, 5508, 5517, 5526, 5535, 5545, 5554, 5563, 5572, 5581, 5591, 5600, 5609, 5618, 5627, 5636, 5645, 5655, 5664, 5673, 5682, 5691, 5700, 5709, 5718, 5727, 5736, 5745, 5754, 5763, 5772, 5780, 5789, 5798, 5807, 5816, 5825, 5834, 5842, 5851, 5860, 5869, 5877, 5886, 5895, 5904, 5912, 5921, 5930, 5938, 5947, 5956, 5964, 5973, 5981, 5990, 5998, 6007, 6016, 6024, 6033, 6041, 6050, 6058, 6066, 6075, 6083, 6092, 6100, 6108, 6117, 6125, 6133, 6142, 6150, 6158, 6167, 6175, 6183, 6191, 6200, 6208, 6216, 6224, 6232, 6240, 6248, 6257, 6265, 6273, 6281, 6289, 6297, 6305, 6313, 6321, 6329, 6337, 6345, 6353, 6361, 6369, 6376, 6384, 6392, 6400, 6408, 6416, 6423, 6431, 6439, 6447, 6454, 6462, 6470, 6478, 6485, 6493, 6501, 6508, 6516, 6523, 6531, 6539, 6546, 6554, 6561, 6569, 6576, 6584, 6591, 6599, 6606, 6613, 6621, 6628, 6636, 6643, 6650, 6658, 6665, 6672, 6679, 6687, 6694, 6701, 6708, 6716, 6723, 6730, 6737, 6744, 6751, 6758, 6765, 6772, 6780, 6787, 6794, 6801, 6808, 6815, 6821, 6828, 6835, 6842, 6849, 6856, 6863, 6870, 6877, 6883, 6890, 6897, 6904, 6910, 6917, 6924, 6931, 6937, 6944, 6951, 6957, 6964, 6970, 6977, 6984, 6990, 6997, 7003, 7010, 7016, 7023, 7029, 7035, 7042, 7048, 7055, 7061, 7067, 7074, 7080, 7086, 7093, 7099, 7105, 7111, 7118, 7124, 7130, 7136, 7142, 7148, 7155, 7161, 7167, 7173, 7179, 7185, 7191, 7197, 7203, 7209, 7215, 7221, 7227, 7232, 7238, 7244, 7250, 7256, 7262, 7267, 7273, 7279, 7285, 7290, 7296, 7302, 7308, 7313, 7319, 7324, 7330, 7336, 7341, 7347, 7352, 7358, 7363, 7369, 7374, 7380, 7385, 7391, 7396, 7401, 7407, 7412, 7417, 7423, 7428, 7433, 7439, 7444, 7449, 7454, 7459, 7465, 7470, 7475, 7480, 7485, 7490, 7495, 7500, 7505, 7510, 7515, 7520, 7525, 7530, 7535, 7540, 7545, 7550, 7555, 7559, 7564, 7569, 7574, 7579, 7583, 7588, 7593, 7597, 7602, 7607, 7611, 7616, 7621, 7625, 7630, 7634, 7639, 7643, 7648, 7652, 7657, 7661, 7666, 7670, 7674, 7679, 7683, 7687, 7692, 7696, 7700, 7705, 7709, 7713, 7717, 7721, 7726, 7730, 7734, 7738, 7742, 7746, 7750, 7754, 7758, 7762, 7766, 7770, 7774, 7778, 7782, 7786, 7790, 7794, 7798, 7801, 7805, 7809, 7813, 7816, 7820, 7824, 7828, 7831, 7835, 7839, 7842, 7846, 7849, 7853, 7856, 7860, 7864, 7867, 7870, 7874, 7877, 7881, 7884, 7888, 7891, 7894, 7898, 7901, 7904, 7907, 7911, 7914, 7917, 7920, 7923, 7927, 7930, 7933, 7936, 7939, 7942, 7945, 7948, 7951, 7954, 7957, 7960, 7963, 7966, 7969, 7972, 7975, 7977, 7980, 7983, 7986, 7989, 7991, 7994, 7997, 7999, 8002, 8005, 8007, 8010, 8013, 8015, 8018, 8020, 8023, 8025, 8028, 8030, 8033, 8035, 8037, 8040, 8042, 8045, 8047, 8049, 8051, 8054, 8056, 8058, 8060, 8063, 8065, 8067, 8069, 8071, 8073, 8075, 8077, 8079, 8082, 8084, 8086, 8087, 8089, 8091, 8093, 8095, 8097, 8099, 8101, 8103, 8104, 8106, 8108, 8110, 8111, 8113, 8115, 8116, 8118, 8120, 8121, 8123, 8124, 8126, 8127, 8129, 8130, 8132, 8133, 8135, 8136, 8138, 8139, 8140, 8142, 8143, 8144, 8146, 8147, 8148, 8149, 8150, 8152, 8153, 8154, 8155, 8156, 8157, 8158, 8159, 8160, 8161, 8162, 8163, 8164, 8165, 8166, 8167, 8168, 8169, 8170, 8171, 8171, 8172, 8173, 8174, 8174, 8175, 8176, 8176, 8177, 8178, 8178, 8179, 8179, 8180, 8180, 8181, 8181, 8182, 8182, 8183, 8183, 8184, 8184, 8184, 8185, 8185, 8185, 8186, 8186, 8186, 8186, 8187, 8187, 8187, 8187, 8187, 8187, 8187, 8187, 8187, 8187, 8188, 8187, 8187, 8187, 8187, 8187, 8187, 8187, 8187, 8187, 8187, 8186, 8186, 8186, 8186, 8185, 8185, 8185, 8184, 8184, 8184, 8183, 8183, 8182, 8182, 8181, 8181, 8180, 8180, 8179, 8179, 8178, 8178, 8177, 8176, 8176, 8175, 8174, 8174, 8173, 8172, 8171, 8171, 8170, 8169, 8168, 8167, 8166, 8165, 8164, 8163, 8162, 8161, 8160, 8159, 8158, 8157, 8156, 8155, 8154, 8153, 8152, 8150, 8149, 8148, 8147, 8146, 8144, 8143, 8142, 8140, 8139, 8138, 8136, 8135, 8133, 8132, 8130, 8129, 8127, 8126, 8124, 8123, 8121, 8120, 8118, 8116, 8115, 8113, 8111, 8110, 8108, 8106, 8104, 8103, 8101, 8099, 8097, 8095, 8093, 8091, 8089, 8087, 8086, 8084, 8082, 8079, 8077, 8075, 8073, 8071, 8069, 8067, 8065, 8063, 8060, 8058, 8056, 8054, 8051, 8049, 8047, 8045, 8042, 8040, 8037, 8035, 8033, 8030, 8028, 8025, 8023, 8020, 8018, 8015, 8013, 8010, 8007, 8005, 8002, 7999, 7997, 7994, 7991, 7989, 7986, 7983, 7980, 7977, 7975, 7972, 7969, 7966, 7963, 7960, 7957, 7954, 7951, 7948, 7945, 7942, 7939, 7936, 7933, 7930, 7927, 7923, 7920, 7917, 7914, 7911, 7907, 7904, 7901, 7898, 7894, 7891, 7888, 7884, 7881, 7877, 7874, 7870, 7867, 7864, 7860, 7856, 7853, 7849, 7846, 7842, 7839, 7835, 7831, 7828, 7824, 7820, 7816, 7813, 7809, 7805, 7801, 7798, 7794, 7790, 7786, 7782, 7778, 7774, 7770, 7766, 7762, 7758, 7754, 7750, 7746, 7742, 7738, 7734, 7730, 7726, 7721, 7717, 7713, 7709, 7705, 7700, 7696, 7692, 7687, 7683, 7679, 7674, 7670, 7666, 7661, 7657, 7652, 7648, 7643, 7639, 7634, 7630, 7625, 7621, 7616, 7611, 7607, 7602, 7597, 7593, 7588, 7583, 7579, 7574, 7569, 7564, 7559, 7555, 7550, 7545, 7540, 7535, 7530, 7525, 7520, 7515, 7510, 7505, 7500, 7495, 7490, 7485, 7480, 7475, 7470, 7465, 7459, 7454, 7449, 7444, 7439, 7433, 7428, 7423, 7417, 7412, 7407, 7401, 7396, 7391, 7385, 7380, 7374, 7369, 7363, 7358, 7352, 7347, 7341, 7336, 7330, 7324, 7319, 7313, 7308, 7302, 7296, 7290, 7285, 7279, 7273, 7267, 7262, 7256, 7250, 7244, 7238, 7232, 7227, 7221, 7215, 7209, 7203, 7197, 7191, 7185, 7179, 7173, 7167, 7161, 7155, 7148, 7142, 7136, 7130, 7124, 7118, 7111, 7105, 7099, 7093, 7086, 7080, 7074, 7067, 7061, 7055, 7048, 7042, 7035, 7029, 7023, 7016, 7010, 7003, 6997, 6990, 6984, 6977, 6970, 6964, 6957, 6951, 6944, 6937, 6931, 6924, 6917, 6910, 6904, 6897, 6890, 6883, 6877, 6870, 6863, 6856, 6849, 6842, 6835, 6828, 6821, 6815, 6808, 6801, 6794, 6787, 6780, 6772, 6765, 6758, 6751, 6744, 6737, 6730, 6723, 6716, 6708, 6701, 6694, 6687, 6679, 6672, 6665, 6658, 6650, 6643, 6636, 6628, 6621, 6613, 6606, 6599, 6591, 6584, 6576, 6569, 6561, 6554, 6546, 6539, 6531, 6523, 6516, 6508, 6501, 6493, 6485, 6478, 6470, 6462, 6454, 6447, 6439, 6431, 6423, 6416, 6408, 6400, 6392, 6384, 6376, 6369, 6361, 6353, 6345, 6337, 6329, 6321, 6313, 6305, 6297, 6289, 6281, 6273, 6265, 6257, 6248, 6240, 6232, 6224, 6216, 6208, 6200, 6191, 6183, 6175, 6167, 6158, 6150, 6142, 6133, 6125, 6117, 6108, 6100, 6092, 6083, 6075, 6066, 6058, 6050, 6041, 6033, 6024, 6016, 6007, 5998, 5990, 5981, 5973, 5964, 5956, 5947, 5938, 5930, 5921, 5912, 5904, 5895, 5886, 5877, 5869, 5860, 5851, 5842, 5834, 5825, 5816, 5807, 5798, 5789, 5780, 5772, 5763, 5754, 5745, 5736, 5727, 5718, 5709, 5700, 5691, 5682, 5673, 5664, 5655, 5645, 5636, 5627, 5618, 5609, 5600, 5591, 5581, 5572, 5563, 5554, 5545, 5535, 5526, 5517, 5508, 5498, 5489, 5480, 5470, 5461, 5452, 5442, 5433, 5423, 5414, 5405, 5395, 5386, 5376, 5367, 5357, 5348, 5338, 5329, 5319, 5310, 5300, 5290, 5281, 5271, 5262, 5252, 5242, 5233, 5223, 5213, 5204, 5194, 5184, 5174, 5165, 5155, 5145, 5135, 5126, 5116, 5106, 5096, 5086, 5077, 5067, 5057, 5047, 5037, 5027, 5017, 5007, 4997, 4987, 4977, 4967, 4957, 4947, 4937, 4927, 4917, 4907, 4897, 4887, 4877, 4867, 4857, 4847, 4837, 4827, 4816, 4806, 4796, 4786, 4776, 4765, 4755, 4745, 4735, 4724, 4714, 4704, 4694, 4683, 4673, 4663, 4652, 4642, 4632, 4621, 4611, 4601, 4590, 4580, 4569, 4559, 4549, 4538, 4528, 4517, 4507, 4496, 4486, 4475, 4465, 4454, 4444, 4433, 4422, 4412, 4401, 4391, 4380, 4369, 4359, 4348, 4338, 4327, 4316, 4306, 4295, 4284, 4273, 4263, 4252, 4241, 4230, 4220, 4209, 4198, 4187, 4177, 4166, 4155, 4144, 4133, 4122, 4112, 4101, 4090, 4079, 4068, 4057, 4046, 4035, 4024, 4013, 4003, 3992, 3981, 3970, 3959, 3948, 3937, 3926, 3915, 3904, 3892, 3881, 3870, 3859, 3848, 3837, 3826, 3815, 3804, 3793, 3782, 3770, 3759, 3748, 3737, 3726, 3715, 3703, 3692, 3681, 3670, 3658, 3647, 3636, 3625, 3613, 3602, 3591, 3580, 3568, 3557, 3546, 3534, 3523, 3512, 3500, 3489, 3478, 3466, 3455, 3443, 3432, 3421, 3409, 3398, 3386, 3375, 3363, 3352, 3341, 3329, 3318, 3306, 3295, 3283, 3272, 3260, 3249, 3237, 3226, 3214, 3202, 3191, 3179, 3168, 3156, 3145, 3133, 3121, 3110, 3098, 3086, 3075, 3063, 3052, 3040, 3028, 3017, 3005, 2993, 2981, 2970, 2958, 2946, 2935, 2923, 2911, 2899, 2888, 2876, 2864, 2852, 2841, 2829, 2817, 2805, 2793, 2782, 2770, 2758, 2746, 2734, 2722, 2711, 2699, 2687, 2675, 2663, 2651, 2639, 2627, 2616, 2604, 2592, 2580, 2568, 2556, 2544, 2532, 2520, 2508, 2496, 2484, 2472, 2460, 2448, 2436, 2424, 2412, 2400, 2388, 2376, 2364, 2352, 2340, 2328, 2316, 2304, 2292, 2280, 2268, 2256, 2244, 2232, 2220, 2208, 2195, 2183, 2171, 2159, 2147, 2135, 2123, 2111, 2098, 2086, 2074, 2062, 2050, 2038, 2026, 2013, 2001, 1989, 1977, 1965, 1952, 1940, 1928, 1916, 1904, 1891, 1879, 1867, 1855, 1842, 1830, 1818, 1806, 1794, 1781, 1769, 1757, 1744, 1732, 1720, 1708, 1695, 1683, 1671, 1658, 1646, 1634, 1622, 1609, 1597, 1585, 1572, 1560, 1548, 1535, 1523, 1511, 1498, 1486, 1474, 1461, 1449, 1436, 1424, 1412, 1399, 1387, 1375, 1362, 1350, 1337, 1325, 1313, 1300, 1288, 1275, 1263, 1251, 1238, 1226, 1213, 1201, 1189, 1176, 1164, 1151, 1139, 1126, 1114, 1101, 1089, 1077, 1064, 1052, 1039, 1027, 1014, 1002, 989, 977, 964, 952, 939, 927, 914, 902, 890, 877, 865, 852, 840, 827, 815, 802, 790, 777, 765, 752, 740, 727, 715, 702, 689, 677, 664, 652, 639, 627, 614, 602, 589, 577, 564, 552, 539, 527, 514, 502, 489, 477, 464, 451, 439, 426, 414, 401, 389, 376, 364, 351, 339, 326, 313, 301, 288, 276, 263, 251, 238, 226, 213, 200, 188, 175, 163, 150, 138, 125, 113, 100, 87, 75, 62, 50, 37, 25, 12, 0, -12, -25, -37, -50, -62, -75, -87, -100, -113, -125, -138, -150, -163, -175, -188, -200, -213, -226, -238, -251, -263, -276, -288, -301, -313, -326, -339, -351, -364, -376, -389, -401, -414, -426, -439, -451, -464, -477, -489, -502, -514, -527, -539, -552, -564, -577, -589, -602, -614, -627, -639, -652, -664, -677, -689, -702, -715, -727, -740, -752, -765, -777, -790, -802, -815, -827, -840, -852, -865, -877, -890, -902, -914, -927, -939, -952, -964, -977, -989, -1002, -1014, -1027, -1039, -1052, -1064, -1077, -1089, -1101, -1114, -1126, -1139, -1151, -1164, -1176, -1189, -1201, -1213, -1226, -1238, -1251, -1263, -1275, -1288, -1300, -1313, -1325, -1337, -1350, -1362, -1375, -1387, -1399, -1412, -1424, -1436, -1449, -1461, -1474, -1486, -1498, -1511, -1523, -1535, -1548, -1560, -1572, -1585, -1597, -1609, -1622, -1634, -1646, -1658, -1671, -1683, -1695, -1708, -1720, -1732, -1744, -1757, -1769, -1781, -1794, -1806, -1818, -1830, -1842, -1855, -1867, -1879, -1891, -1904, -1916, -1928, -1940, -1952, -1965, -1977, -1989, -2001, -2013, -2026, -2038, -2050, -2062, -2074, -2086, -2098, -2111, -2123, -2135, -2147, -2159, -2171, -2183, -2195, -2208, -2220, -2232, -2244, -2256, -2268, -2280, -2292, -2304, -2316, -2328, -2340, -2352, -2364, -2376, -2388, -2400, -2412, -2424, -2436, -2448, -2460, -2472, -2484, -2496, -2508, -2520, -2532, -2544, -2556, -2568, -2580, -2592, -2604, -2616, -2627, -2639, -2651, -2663, -2675, -2687, -2699, -2711, -2722, -2734, -2746, -2758, -2770, -2782, -2793, -2805, -2817, -2829, -2841, -2852, -2864, -2876, -2888, -2899, -2911, -2923, -2935, -2946, -2958, -2970, -2981, -2993, -3005, -3017, -3028, -3040, -3052, -3063, -3075, -3086, -3098, -3110, -3121, -3133, -3145, -3156, -3168, -3179, -3191, -3202, -3214, -3226, -3237, -3249, -3260, -3272, -3283, -3295, -3306, -3318, -3329, -3341, -3352, -3363, -3375, -3386, -3398, -3409, -3421, -3432, -3443, -3455, -3466, -3478, -3489, -3500, -3512, -3523, -3534, -3546, -3557, -3568, -3580, -3591, -3602, -3613, -3625, -3636, -3647, -3658, -3670, -3681, -3692, -3703, -3715, -3726, -3737, -3748, -3759, -3770, -3782, -3793, -3804, -3815, -3826, -3837, -3848, -3859, -3870, -3881, -3892, -3904, -3915, -3926, -3937, -3948, -3959, -3970, -3981, -3992, -4003, -4013, -4024, -4035, -4046, -4057, -4068, -4079, -4090, -4101, -4112, -4122, -4133, -4144, -4155, -4166, -4177, -4187, -4198, -4209, -4220, -4230, -4241, -4252, -4263, -4273, -4284, -4295, -4306, -4316, -4327, -4338, -4348, -4359, -4369, -4380, -4391, -4401, -4412, -4422, -4433, -4444, -4454, -4465, -4475, -4486, -4496, -4507, -4517, -4528, -4538, -4549, -4559, -4569, -4580, -4590, -4601, -4611, -4621, -4632, -4642, -4652, -4663, -4673, -4683, -4694, -4704, -4714, -4724, -4735, -4745, -4755, -4765, -4776, -4786, -4796, -4806, -4816, -4827, -4837, -4847, -4857, -4867, -4877, -4887, -4897, -4907, -4917, -4927, -4937, -4947, -4957, -4967, -4977, -4987, -4997, -5007, -5017, -5027, -5037, -5047, -5057, -5067, -5077, -5086, -5096, -5106, -5116, -5126, -5135, -5145, -5155, -5165, -5174, -5184, -5194, -5204, -5213, -5223, -5233, -5242, -5252, -5262, -5271, -5281, -5290, -5300, -5310, -5319, -5329, -5338, -5348, -5357, -5367, -5376, -5386, -5395, -5405, -5414, -5423, -5433, -5442, -5452, -5461, -5470, -5480, -5489, -5498, -5508, -5517, -5526, -5535, -5545, -5554, -5563, -5572, -5581, -5591, -5600, -5609, -5618, -5627, -5636, -5645, -5655, -5664, -5673, -5682, -5691, -5700, -5709, -5718, -5727, -5736, -5745, -5754, -5763, -5772, -5780, -5789, -5798, -5807, -5816, -5825, -5834, -5842, -5851, -5860, -5869, -5877, -5886, -5895, -5904, -5912, -5921, -5930, -5938, -5947, -5956, -5964, -5973, -5981, -5990, -5998, -6007, -6016, -6024, -6033, -6041, -6050, -6058, -6066, -6075, -6083, -6092, -6100, -6108, -6117, -6125, -6133, -6142, -6150, -6158, -6167, -6175, -6183, -6191, -6200, -6208, -6216, -6224, -6232, -6240, -6248, -6257, -6265, -6273, -6281, -6289, -6297, -6305, -6313, -6321, -6329, -6337, -6345, -6353, -6361, -6369, -6376, -6384, -6392, -6400, -6408, -6416, -6423, -6431, -6439, -6447, -6454, -6462, -6470, -6478, -6485, -6493, -6501, -6508, -6516, -6523, -6531, -6539, -6546, -6554, -6561, -6569, -6576, -6584, -6591, -6599, -6606, -6613, -6621, -6628, -6636, -6643, -6650, -6658, -6665, -6672, -6679, -6687, -6694, -6701, -6708, -6716, -6723, -6730, -6737, -6744, -6751, -6758, -6765, -6772, -6780, -6787, -6794, -6801, -6808, -6815, -6821, -6828, -6835, -6842, -6849, -6856, -6863, -6870, -6877, -6883, -6890, -6897, -6904, -6910, -6917, -6924, -6931, -6937, -6944, -6951, -6957, -6964, -6970, -6977, -6984, -6990, -6997, -7003, -7010, -7016, -7023, -7029, -7035, -7042, -7048, -7055, -7061, -7067, -7074, -7080, -7086, -7093, -7099, -7105, -7111, -7118, -7124, -7130, -7136, -7142, -7148, -7155, -7161, -7167, -7173, -7179, -7185, -7191, -7197, -7203, -7209, -7215, -7221, -7227, -7232, -7238, -7244, -7250, -7256, -7262, -7267, -7273, -7279, -7285, -7290, -7296, -7302, -7308, -7313, -7319, -7324, -7330, -7336, -7341, -7347, -7352, -7358, -7363, -7369, -7374, -7380, -7385, -7391, -7396, -7401, -7407, -7412, -7417, -7423, -7428, -7433, -7439, -7444, -7449, -7454, -7459, -7465, -7470, -7475, -7480, -7485, -7490, -7495, -7500, -7505, -7510, -7515, -7520, -7525, -7530, -7535, -7540, -7545, -7550, -7555, -7559, -7564, -7569, -7574, -7579, -7583, -7588, -7593, -7597, -7602, -7607, -7611, -7616, -7621, -7625, -7630, -7634, -7639, -7643, -7648, -7652, -7657, -7661, -7666, -7670, -7674, -7679, -7683, -7687, -7692, -7696, -7700, -7705, -7709, -7713, -7717, -7721, -7726, -7730, -7734, -7738, -7742, -7746, -7750, -7754, -7758, -7762, -7766, -7770, -7774, -7778, -7782, -7786, -7790, -7794, -7798, -7801, -7805, -7809, -7813, -7816, -7820, -7824, -7828, -7831, -7835, -7839, -7842, -7846, -7849, -7853, -7856, -7860, -7864, -7867, -7870, -7874, -7877, -7881, -7884, -7888, -7891, -7894, -7898, -7901, -7904, -7907, -7911, -7914, -7917, -7920, -7923, -7927, -7930, -7933, -7936, -7939, -7942, -7945, -7948, -7951, -7954, -7957, -7960, -7963, -7966, -7969, -7972, -7975, -7977, -7980, -7983, -7986, -7989, -7991, -7994, -7997, -7999, -8002, -8005, -8007, -8010, -8013, -8015, -8018, -8020, -8023, -8025, -8028, -8030, -8033, -8035, -8037, -8040, -8042, -8045, -8047, -8049, -8051, -8054, -8056, -8058, -8060, -8063, -8065, -8067, -8069, -8071, -8073, -8075, -8077, -8079, -8082, -8084, -8086, -8087, -8089, -8091, -8093, -8095, -8097, -8099, -8101, -8103, -8104, -8106, -8108, -8110, -8111, -8113, -8115, -8116, -8118, -8120, -8121, -8123, -8124, -8126, -8127, -8129, -8130, -8132, -8133, -8135, -8136, -8138, -8139, -8140, -8142, -8143, -8144, -8146, -8147, -8148, -8149, -8150, -8152, -8153, -8154, -8155, -8156, -8157, -8158, -8159, -8160, -8161, -8162, -8163, -8164, -8165, -8166, -8167, -8168, -8169, -8170, -8171, -8171, -8172, -8173, -8174, -8174, -8175, -8176, -8176, -8177, -8178, -8178, -8179, -8179, -8180, -8180, -8181, -8181, -8182, -8182, -8183, -8183, -8184, -8184, -8184, -8185, -8185, -8185, -8186, -8186, -8186, -8186, -8187, -8187, -8187, -8187, -8187, -8187, -8187, -8187, -8187, -8187, -8188, -8187, -8187, -8187, -8187, -8187, -8187, -8187, -8187, -8187, -8187, -8186, -8186, -8186, -8186, -8185, -8185, -8185, -8184, -8184, -8184, -8183, -8183, -8182, -8182, -8181, -8181, -8180, -8180, -8179, -8179, -8178, -8178, -8177, -8176, -8176, -8175, -8174, -8174, -8173, -8172, -8171, -8171, -8170, -8169, -8168, -8167, -8166, -8165, -8164, -8163, -8162, -8161, -8160, -8159, -8158, -8157, -8156, -8155, -8154, -8153, -8152, -8150, -8149, -8148, -8147, -8146, -8144, -8143, -8142, -8140, -8139, -8138, -8136, -8135, -8133, -8132, -8130, -8129, -8127, -8126, -8124, -8123, -8121, -8120, -8118, -8116, -8115, -8113, -8111, -8110, -8108, -8106, -8104, -8103, -8101, -8099, -8097, -8095, -8093, -8091, -8089, -8087, -8086, -8084, -8082, -8079, -8077, -8075, -8073, -8071, -8069, -8067, -8065, -8063, -8060, -8058, -8056, -8054, -8051, -8049, -8047, -8045, -8042, -8040, -8037, -8035, -8033, -8030, -8028, -8025, -8023, -8020, -8018, -8015, -8013, -8010, -8007, -8005, -8002, -7999, -7997, -7994, -7991, -7989, -7986, -7983, -7980, -7977, -7975, -7972, -7969, -7966, -7963, -7960, -7957, -7954, -7951, -7948, -7945, -7942, -7939, -7936, -7933, -7930, -7927, -7923, -7920, -7917, -7914, -7911, -7907, -7904, -7901, -7898, -7894, -7891, -7888, -7884, -7881, -7877, -7874, -7870, -7867, -7864, -7860, -7856, -7853, -7849, -7846, -7842, -7839, -7835, -7831, -7828, -7824, -7820, -7816, -7813, -7809, -7805, -7801, -7798, -7794, -7790, -7786, -7782, -7778, -7774, -7770, -7766, -7762, -7758, -7754, -7750, -7746, -7742, -7738, -7734, -7730, -7726, -7721, -7717, -7713, -7709, -7705, -7700, -7696, -7692, -7687, -7683, -7679, -7674, -7670, -7666, -7661, -7657, -7652, -7648, -7643, -7639, -7634, -7630, -7625, -7621, -7616, -7611, -7607, -7602, -7597, -7593, -7588, -7583, -7579, -7574, -7569, -7564, -7559, -7555, -7550, -7545, -7540, -7535, -7530, -7525, -7520, -7515, -7510, -7505, -7500, -7495, -7490, -7485, -7480, -7475, -7470, -7465, -7459, -7454, -7449, -7444, -7439, -7433, -7428, -7423, -7417, -7412, -7407, -7401, -7396, -7391, -7385, -7380, -7374, -7369, -7363, -7358, -7352, -7347, -7341, -7336, -7330, -7324, -7319, -7313, -7308, -7302, -7296, -7290, -7285, -7279, -7273, -7267, -7262, -7256, -7250, -7244, -7238, -7232, -7227, -7221, -7215, -7209, -7203, -7197, -7191, -7185, -7179, -7173, -7167, -7161, -7155, -7148, -7142, -7136, -7130, -7124, -7118, -7111, -7105, -7099, -7093, -7086, -7080, -7074, -7067, -7061, -7055, -7048, -7042, -7035, -7029, -7023, -7016, -7010, -7003, -6997, -6990, -6984, -6977, -6970, -6964, -6957, -6951, -6944, -6937, -6931, -6924, -6917, -6910, -6904, -6897, -6890, -6883, -6877, -6870, -6863, -6856, -6849, -6842, -6835, -6828, -6821, -6815, -6808, -6801, -6794, -6787, -6780, -6772, -6765, -6758, -6751, -6744, -6737, -6730, -6723, -6716, -6708, -6701, -6694, -6687, -6679, -6672, -6665, -6658, -6650, -6643, -6636, -6628, -6621, -6613, -6606, -6599, -6591, -6584, -6576, -6569, -6561, -6554, -6546, -6539, -6531, -6523, -6516, -6508, -6501, -6493, -6485, -6478, -6470, -6462, -6454, -6447, -6439, -6431, -6423, -6416, -6408, -6400, -6392, -6384, -6376, -6369, -6361, -6353, -6345, -6337, -6329, -6321, -6313, -6305, -6297, -6289, -6281, -6273, -6265, -6257, -6248, -6240, -6232, -6224, -6216, -6208, -6200, -6191, -6183, -6175, -6167, -6158, -6150, -6142, -6133, -6125, -6117, -6108, -6100, -6092, -6083, -6075, -6066, -6058, -6050, -6041, -6033, -6024, -6016, -6007, -5998, -5990, -5981, -5973, -5964, -5956, -5947, -5938, -5930, -5921, -5912, -5904, -5895, -5886, -5877, -5869, -5860, -5851, -5842, -5834, -5825, -5816, -5807, -5798, -5789, -5780, -5772, -5763, -5754, -5745, -5736, -5727, -5718, -5709, -5700, -5691, -5682, -5673, -5664, -5655, -5645, -5636, -5627, -5618, -5609, -5600, -5591, -5581, -5572, -5563, -5554, -5545, -5535, -5526, -5517, -5508, -5498, -5489, -5480, -5470, -5461, -5452, -5442, -5433, -5423, -5414, -5405, -5395, -5386, -5376, -5367, -5357, -5348, -5338, -5329, -5319, -5310, -5300, -5290, -5281, -5271, -5262, -5252, -5242, -5233, -5223, -5213, -5204, -5194, -5184, -5174, -5165, -5155, -5145, -5135, -5126, -5116, -5106, -5096, -5086, -5077, -5067, -5057, -5047, -5037, -5027, -5017, -5007, -4997, -4987, -4977, -4967, -4957, -4947, -4937, -4927, -4917, -4907, -4897, -4887, -4877, -4867, -4857, -4847, -4837, -4827, -4816, -4806, -4796, -4786, -4776, -4765, -4755, -4745, -4735, -4724, -4714, -4704, -4694, -4683, -4673, -4663, -4652, -4642, -4632, -4621, -4611, -4601, -4590, -4580, -4569, -4559, -4549, -4538, -4528, -4517, -4507, -4496, -4486, -4475, -4465, -4454, -4444, -4433, -4422, -4412, -4401, -4391, -4380, -4369, -4359, -4348, -4338, -4327, -4316, -4306, -4295, -4284, -4273, -4263, -4252, -4241, -4230, -4220, -4209, -4198, -4187, -4177, -4166, -4155, -4144, -4133, -4122, -4112, -4101, -4090, -4079, -4068, -4057, -4046, -4035, -4024, -4013, -4003, -3992, -3981, -3970, -3959, -3948, -3937, -3926, -3915, -3904, -3892, -3881, -3870, -3859, -3848, -3837, -3826, -3815, -3804, -3793, -3782, -3770, -3759, -3748, -3737, -3726, -3715, -3703, -3692, -3681, -3670, -3658, -3647, -3636, -3625, -3613, -3602, -3591, -3580, -3568, -3557, -3546, -3534, -3523, -3512, -3500, -3489, -3478, -3466, -3455, -3443, -3432, -3421, -3409, -3398, -3386, -3375, -3363, -3352, -3341, -3329, -3318, -3306, -3295, -3283, -3272, -3260, -3249, -3237, -3226, -3214, -3202, -3191, -3179, -3168, -3156, -3145, -3133, -3121, -3110, -3098, -3086, -3075, -3063, -3052, -3040, -3028, -3017, -3005, -2993, -2981, -2970, -2958, -2946, -2935, -2923, -2911, -2899, -2888, -2876, -2864, -2852, -2841, -2829, -2817, -2805, -2793, -2782, -2770, -2758, -2746, -2734, -2722, -2711, -2699, -2687, -2675, -2663, -2651, -2639, -2627, -2616, -2604, -2592, -2580, -2568, -2556, -2544, -2532, -2520, -2508, -2496, -2484, -2472, -2460, -2448, -2436, -2424, -2412, -2400, -2388, -2376, -2364, -2352, -2340, -2328, -2316, -2304, -2292, -2280, -2268, -2256, -2244, -2232, -2220, -2208, -2195, -2183, -2171, -2159, -2147, -2135, -2123, -2111, -2098, -2086, -2074, -2062, -2050, -2038, -2026, -2013, -2001, -1989, -1977, -1965, -1952, -1940, -1928, -1916, -1904, -1891, -1879, -1867, -1855, -1842, -1830, -1818, -1806, -1794, -1781, -1769, -1757, -1744, -1732, -1720, -1708, -1695, -1683, -1671, -1658, -1646, -1634, -1622, -1609, -1597, -1585, -1572, -1560, -1548, -1535, -1523, -1511, -1498, -1486, -1474, -1461, -1449, -1436, -1424, -1412, -1399, -1387, -1375, -1362, -1350, -1337, -1325, -1313, -1300, -1288, -1275, -1263, -1251, -1238, -1226, -1213, -1201, -1189, -1176, -1164, -1151, -1139, -1126, -1114, -1101, -1089, -1077, -1064, -1052, -1039, -1027, -1014, -1002, -989, -977, -964, -952, -939, -927, -914, -902, -890, -877, -865, -852, -840, -827, -815, -802, -790, -777, -765, -752, -740, -727, -715, -702, -689, -677, -664, -652, -639, -627, -614, -602, -589, -577, -564, -552, -539, -527, -514, -502, -489, -477, -464, -451, -439, -426, -414, -401, -389, -376, -364, -351, -339, -326, -313, -301, -288, -276, -263, -251, -238, -226, -213, -200, -188, -175, -163, -150, -138, -125, -113, -100, -87, -75, -62, -50, -37, -25, -12 };

/*
 * Initializes necessary pins of ch32v203
 */
void GPIO_Init_All(void) {
    RCC->APB2PCENR |= RCC_APB2Periph_GPIOA;

    // SPI1: PA5=SCK, PA7=MOSI, rest unnecessary
	GPIOA->CFGLR = ( GPIO_Speed_50MHz | GPIO_CNF_OUT_PP_AF ) << ( 4 * 5 ) |
	               ( GPIO_Speed_50MHz | GPIO_CNF_OUT_PP_AF ) << ( 4 * 7 ) |
	               ( GPIO_Speed_50MHz | GPIO_CNF_OUT_PP_AF ) << ( 4 * 1 );

	// PA0 bound to TIM2_ETR
	GPIOA->CFGLR |= ( GPIO_CFGLR_IN_FLOAT ) << ( 4 * 0 );
}

/*
 * Initializes SPI and DMA
 * SPI Pins
 *  - MOSI PA7
 *  - MISO PA6
 *  - SCK PA5
 *  - NSS PA4
 */
void SPI1_DMA_Init(void) {
    RCC->APB2PCENR |= RCC_APB2Periph_SPI1;
    RCC->AHBPCENR  |= RCC_AHBPeriph_DMA1;

    // Turn of SPI before setting up
    SPI1->CTLR1 &= ~SPI_CTLR1_SPE;
	SPI1->CTLR1 = SPI_CTLR1_MSTR |
                  SPI_CTLR1_CPOL | 
                  SPI_CTLR1_CPHA |
                  SPI_DataSize_16b |
                  SPI_CTLR1_SSM |
                  SPI_CTLR1_SSI |
                  SPI_BaudRatePrescaler_64 | 
                  SPI_CTLR1_SPE;

    // Enable SPI DMA
    SPI1->CTLR2 = SPI_CTLR2_TXDMAEN;

    // DMA1 Channel3 (SPI1_TX)
	DMA1_Channel3->CFGR = DMA_CFGR3_MINC | 
                          DMA_CFGR3_DIR |
                          DMA_CFGR3_CIRC |
                          DMA_CFGR3_PSIZE_0 | 
                          DMA_CFGR3_MSIZE_0;
	DMA1_Channel3->PADDR = (uint32_t)&SPI1->DATAR;
    DMA1_Channel3->MADDR = (uint32_t)audio_buffer;
    DMA1_Channel3->CNTR  = SAMPLES;

    // Enable DMA
    DMA1_Channel3->CFGR |= DMA_CFGR3_EN;
}

/*
 * Set up TIM2 to trigger based on SPI SCK so we can have "synced" clocks. The
 * clocks aren't synced perfectly, but good enough to bitbang I2S. So it's
 * functionally good enough. Kind of ugly solution, must connect PA5 (SCK+BCLK)
 * to PA0 (TIM2_ETR). The output for WS/LRCK is PA1.
 */
void TIM2_Init_SPI_Trigger(void) {
	// Enable TIM2 clock
	RCC->APB1PCENR |= RCC_APB1Periph_TIM2;

	// Reset TIM2
	RCC->APB1PRSTR |= RCC_APB1Periph_TIM2;
	RCC->APB1PRSTR &= ~RCC_APB1Periph_TIM2;

	// Set auto-reload (ARR) for PWM frequency (divide by 32) 16 Left + 16 Right
	TIM2->ATRLR = (BITS_PER_SAMPLE<<1)-1;
	TIM2->CH2CVR = (TIM2->ATRLR+1) >> 1;

	// Configure CH2 as PWM1
	TIM2->CHCTLR1 &= ~0xFF00;
	TIM2->CHCTLR1 |= TIM_OC2M_1 | TIM_OC2M_2;
	TIM2->CCER |= TIM_CC2E;

	// External trigger source = ETRF
	TIM2->SMCFGR = TIM_TS_ETRF | TIM_MSM | TIM_ETP;

	// External clock mode
	TIM2->SMCFGR &= ~TIM_SMS;
	TIM2->SMCFGR |= TIM_SMS;

	// Start timer
	TIM2->CTLR1 |= TIM_CEN;
}


/*
 * Put the sounds into the buffer thing
 */
void update_dma_buffer(void) {
    int voices = 4;
    for(int i=0;i<SAMPLES;i++) {
        // Base Freq * 2
        audio_buffer[i] = cos_lut[(2*i)%(SAMPLES-1)]/voices;

        // Harmonics
        for(int j=1;j<4;j++) {
            audio_buffer[i] += cos_lut[2*i*(2*j+1)&(SAMPLES-1)]/(2*j+1);
        }
        // for(int j=1;j<voices;j++) {
        //     audio_buffer[i] += cos_lut[13*i/2*(2*j)&(SAMPLES-1)]/(voices);
        // }
        // audio_buffer[i] >>= 1;
        // audio_buffer[i] = -SAMPLES+i*4;
    }
}

int main(void) {
    SystemInit();
    GPIO_Init_All();
    update_dma_buffer();
    SPI1_DMA_Init();
    TIM2_Init_SPI_Trigger();

    while(1) {
        // update_dma_buffer();
    }
}
